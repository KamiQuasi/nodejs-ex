<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<dom-module id="rhd-search-query">
  <template>
    <iron-ajax auto id="ajax" url="/search" 
    params='{"part":"snippet", "q":"{{filters.term}}"}'
    handle-as="json"
    on-response="adjustResults"></iron-ajax>
  </template>

  <script>
    class RHDSearchQuery extends Polymer.Element {
      static get is() { return 'rhd-search-query'; }
      static get properties() {
        return {
          term: String,
          filters: Object,
          results: {
              type: Object,
              notify: true
          },
          limit: Number
        };
      }

      static get observers() {
        return [
            'runQuery(filters)'
        ]
      }

      runQuery(filters) {
        this.$.ajax.generateRequest();
      }
      adjustResults(results) {
        let qr = results.detail.response;
        let hits = qr ? qr.hits.hits : [];
        let f = [];
        let l = hits.length;
        if(this.filters.term && this.filters.term.length > 0) {
          for(let i=0; i<l; i++) {
            if(this.checkFilters(hits[i].fields, this.filters)) {
              f.push(hits[i]);
            }
          }
        }
        if (qr) {
          qr.hits.hits = f.slice(0, this.get('limit'));
          qr.hits.total = f.length;
        }
        this.set('results', qr);
      }

      checkFilters(fields, filters) {
        let includes = false;
        let keys = filters ? Object.keys(filters) : {};
        let l = keys.length;
        if(fields) {
          for(let i=0; i<l; i++) {
            switch (typeof filters[keys[i]]) {
              case 'object':
                if (fields[keys[i]] && fields[keys[i]] == filters[keys[i]]) {
                  return true;
                }
                break;
              case 'array':

                break;
              case 'string':
                if(fields.sys_description && fields.sys_description.length && fields.sys_description[0].indexOf(filters[keys[i]]) > -1) {
                  return true;
                }
                if(fields.sys_tags && fields.sys_tags.length && fields.sys_tags.indexOf(filters[keys[i]]) > -1) {
                  return true;
                }
                if(fields.sys_title && fields.sys_title.length && fields.sys_title[0].indexOf(filters[keys[i]]) > -1) {
                  return true;
                }
                break;
            }
          }
        }

        return includes;
      }

      verifyValue(filter, fields) {
        
        return false;
      }
    }

    window.customElements.define(RHDSearchQuery.is, RHDSearchQuery);
  </script>
</dom-module>
